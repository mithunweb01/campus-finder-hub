<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Finder ‚Äî Messages</title>
  <link rel="canonical" href="https://mithunweb01.github.io/">
  <meta name="description" content="Find colleges in Tamil Nadu (Chennai, Coimbatore, Pondicherry, Trichy, Madurai, Salem).">
  <meta name="author" content="Mithun">
  <link rel="icon" href="my-logo.jpg" />

  <style>
    :root{--brand:#0a3d62;--accent:#ffcc00;--bg:#eef3f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#123}
    header{background:var(--brand);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:40}
    header h1{margin:0;font-size:20px}
    .wrap{display:flex;gap:18px;max-width:1100px;margin:18px auto;padding:0 12px}
    .sidebar{width:230px;background:var(--brand);color:#fff;border-radius:10px;padding:12px;min-height:70vh;position:sticky;top:88px}
    .logo{display:flex;gap:8px;align-items:center}
    .logo img{height:44px;width:44px;border-radius:8px;object-fit:cover}
    .tab-button{display:block;padding:10px 12px;color:#fff;text-decoration:none;border-radius:6px;margin:6px 0;border-left:4px solid transparent;cursor:pointer;background:transparent;border:none;text-align:left}
    .tab-button:hover{background:#074068}
    .tab-button.active{background:#052a4a;border-left:4px solid var(--accent)}
    main{flex:1}
    .card{background:var(--card);padding:14px;border-radius:10px;margin-bottom:16px;box-shadow:0 6px 18px rgba(6,30,60,0.06)}
    .flip-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .flip{background:linear-gradient(135deg,#fff,#dbe9ff);border-radius:10px;height:130px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:12px;position:relative;cursor:pointer;font-weight:700}
    .view-btn{position:absolute;right:10px;bottom:10px;background:var(--accent);color:#111;padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-weight:700}
    /* messages */
    #messages-wrap{display:flex;gap:12px;height:70vh}
    .chats-list{width:320px;background:var(--card);border-radius:10px;padding:10px;overflow:auto}
    .chat-window{flex:1;background:var(--card);border-radius:10px;padding:10px;display:flex;flex-direction:column}
    .chat-header{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid #eee}
    .messages{flex:1;overflow:auto;padding:12px}
    .msg{display:inline-block;max-width:80%;padding:8px 12px;margin:8px 0;border-radius:12px}
    .msg.user{background:#d9eaff;margin-left:auto}
    .msg.admin{background:#f1f1f1;margin-right:auto}
    .chat-input{display:flex;gap:8px;padding-top:8px}
    .chat-input input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    .chat-input button{padding:10px 14px;border-radius:8px;border:none;background:var(--brand);color:#fff;cursor:pointer}
    input[type="email"], input[type="password"], input[type="text"], input[type="date"]{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
    .small{font-size:13px;color:#666}

    /* notification badges and flash */
    .red-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#e53935;margin-left:8px;vertical-align:middle}
    .row-highlight{background:linear-gradient(90deg, rgba(255,249,196,0.9), rgba(255,255,255,0.6));}
    .notify-flash{animation:flashit 1.2s ease-in-out}
    @keyframes flashit{0%{box-shadow:0 0 0 rgba(255,204,0,0)}30%{box-shadow:0 6px 18px rgba(255,204,0,0.18);transform:translateY(-2px)}60%{box-shadow:0 2px 8px rgba(255,204,0,0.08);transform:translateY(0)}100%{box-shadow:0 0 0 rgba(255,204,0,0);transform:translateY(0)}}

    @media(max-width:900px){
      .wrap{flex-direction:column;padding:0 10px;margin-top:10px}
      .sidebar{width:100%;display:flex;overflow-x:auto;gap:4px;padding:6px;min-height:auto;background:var(--brand);border-radius:8px}
      .sidebar .logo{display:none}
      .tab-button{flex:0 0 auto;padding:6px 10px;font-size:13px;border-left:none;border-bottom:3px solid transparent;white-space:nowrap}
      .tab-button.active{border-bottom:3px solid var(--accent)}
      #messages-wrap{flex-direction:column;height:60vh}
      .chats-list{width:100%}
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="my-logo.jpg" alt="logo" style="height:36px;width:36px;border-radius:6px;object-fit:cover">
    <h1>College Finder</h1>
  </div>
  <div id="auth-area" style="display:flex;align-items:center;gap:12px">
    <span id="welcomeTxt" style="color:#fff;font-size:14px">Not signed in</span>
    <button id="btn-auth" style="background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer">Login / Signup</button>
  </div>
</header>

<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <img src="my-logo.jpg" alt="logo">
      <div style="margin-left:8px">
        <strong>College Finder</strong>
        <div class="small">Tamil Nadu colleges</div>
      </div>
    </div>

    <button class="tab-button active" data-tab="home">üè† Home</button>
    <button class="tab-button" data-tab="chennai">Chennai</button>
    <button class="tab-button" data-tab="pondy">Pondicherry</button>
    <button class="tab-button" data-tab="coimbatore">Coimbatore</button>
    <button class="tab-button" data-tab="trichy">Trichy</button>
    <button class="tab-button" data-tab="madurai">Madurai</button>
    <button class="tab-button" data-tab="salem">Salem</button>

    <div style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.06);padding-top:12px">
      <div class="small" style="color:#dfe9f5">Logged in user</div>
      <div id="sidebar-user" style="font-weight:700;margin-top:6px">‚Äî</div>
      <button id="btn-logout" class="tab-button" style="background:transparent;margin-top:10px;color:#fff">Logout</button>
    </div>
  </aside>

  <main style="flex:1">
    <!-- HOME -->
    <section id="home" class="card" data-section>
      <h2>Welcome to College Finder</h2>
      <p class="small">This site lists colleges in Tamil Nadu. Click any card's <b>View</b> ‚Äî you'll be asked to login if not signed in.</p>

      <div class="card" id="flip-board">
        <h3 style="margin-top:0;color:darkred;text-align:center">Explore All Colleges Quickly</h3>
        <div class="flip-grid" id="flip-grid"></div>
      </div>
    </section>

    <!-- Cities -->
    <section id="chennai" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Chennai</h2><div id="chennai-content">Loading‚Ä¶</div></section>
    <section id="pondy" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Pondicherry</h2><div id="pondy-content">Loading‚Ä¶</div></section>
    <section id="coimbatore" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Coimbatore</h2><div id="coimbatore-content">Loading‚Ä¶</div></section>
    <section id="trichy" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Trichy</h2><div id="trichy-content">Loading‚Ä¶</div></section>
    <section id="madurai" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Madurai</h2><div id="madurai-content">Loading‚Ä¶</div></section>
    <section id="salem" class="card" data-section style="display:none"><h2 style="text-align:center;color:darkred">Salem</h2><div id="salem-content">Loading‚Ä¶</div></section>

    <!-- Messages (per-user) -->
    <section id="messages" class="card" data-section style="display:none">
      <h2 style="text-align:center;color:darkred">Messages</h2>
      <div id="messages-wrap">
        <div class="chats-list" id="user-chat-list"><div style="font-weight:700">Your Chat</div><div class="small" style="margin-top:6px">Messages are synced with Firebase.</div></div>
        <div class="chat-window">
          <div class="chat-header"><strong id="chat-with">Admin</strong></div>
          <div class="messages" id="chat-messages"></div>
          <div class="chat-input">
            <input id="chat-input" placeholder="Type your message..." />
            <button id="chat-send">Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" data-section style="display:none">
      <h2 style="text-align:center;color:darkred">Admin Dashboard</h2>
      <div style="display:flex;gap:12px">
        <div class="chats-list" id="admin-user-list"><div style="font-weight:700">Users</div></div>
        <div class="chat-window">
          <div class="chat-header" id="admin-chat-header"><strong>Select a user</strong></div>
          <div class="messages" id="admin-chat-messages"></div>
          <div class="chat-input">
            <input id="admin-chat-input" placeholder="Reply..." />
            <button id="admin-chat-send">Send</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Auth modal -->
<div id="authModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60">
  <div style="background:#fff;padding:18px;border-radius:10px;width:320px;max-width:95%">
    <h3 style="margin:0 0 8px 0">Login / Signup</h3>
    <input id="authEmail" type="email" placeholder="Email" />
    <input id="authPass" type="password" placeholder="Password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="authLogin" style="flex:1;padding:10px;background:var(--brand);color:#fff;border:none;border-radius:6px">Login</button>
      <button id="authSignup" style="flex:1;padding:10px;background:#ffcc00;border:none;border-radius:6px">Signup</button>
    </div>
    <div style="margin-top:8px;text-align:right"><button id="authClose" style="background:transparent;border:none;color:#666">Close</button></div>
  </div>
</div>

<!-- Single-module script - contains Firebase imports + app code -->
<script type="module">
/* ---------------- FIREBASE MODULE IMPORTS ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  set,
  onChildAdded,
  onValue,
  off,
  get,
  update
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

/* ---------------- CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDjW_3cYR8apPFMmZqLqZh_9i2bN-1IEmY",
  authDomain: "college-finder-279aa.firebaseapp.com",
  databaseURL: "https://college-finder-279aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "college-finder-279aa",
  storageBucket: "college-finder-279aa.firebasestorage.app",
  messagingSenderId: "94401695690",
  appId: "1:94401695690:web:cc08b09173d329de944933",
  measurementId: "G-R8D5FF0HEH"
};

/* ---------------- INIT ---------------- */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const ADMIN_EMAIL = "mithun@admin.com"; // adjust if needed

/* ---------------- DOM REFS ---------------- */
const welcomeTxt = document.getElementById('welcomeTxt');
const btnAuth = document.getElementById('btn-auth');
const authModal = document.getElementById('authModal');
const authEmail = document.getElementById('authEmail');
const authPass = document.getElementById('authPass');
const authLogin = document.getElementById('authLogin');
const authSignup = document.getElementById('authSignup');
const authClose = document.getElementById('authClose');
const sidebarUser = document.getElementById('sidebar-user');
const btnLogout = document.getElementById('btn-logout');

const chatMessages = document.getElementById('chat-messages');
const userChatList = document.getElementById('user-chat-list');
const chatSend = document.getElementById('chat-send');
const chatInput = document.getElementById('chat-input');

const adminUserList = document.getElementById('admin-user-list');
const adminChatMessages = document.getElementById('admin-chat-messages');
const adminChatHeader = document.getElementById('admin-chat-header');
const adminChatInput = document.getElementById('admin-chat-input');
const adminChatSend = document.getElementById('admin-chat-send');

let currentUser = null;
let currentUserUid = null;
let currentAdminChatUid = null;

/* ---------------- HELPER: meta path ---------------- */
const metaPath = uid => `meta/${uid}`;

/* ---------------- Notification small utils ---------------- */
function playBeep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(880, ctx.currentTime);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.28);
  } catch(e) { /* ignore */ }
}

function transientToast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  Object.assign(el.style, {
    position:'fixed', right:'18px', bottom:'18px', background:'#0a3d62', color:'#fff',
    padding:'10px 14px', borderRadius:'8px', zIndex:99999, boxShadow:'0 6px 18px rgba(6,30,60,0.16)'
  });
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 2600);
}

/* inject small CSS for badges / flash */
(function addNotifCSS(){
  const css = `.red-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#e53935;margin-left:8px;vertical-align:middle}
  .row-highlight{background:linear-gradient(90deg, rgba(255,249,196,0.9), rgba(255,255,255,0.6))}
  .notify-flash{animation:flashit 1.2s ease-in-out}
  @keyframes flashit{0%{box-shadow:0 0 0 rgba(255,204,0,0)}30%{box-shadow:0 6px 18px rgba(255,204,0,0.18);transform:translateY(-2px)}60%{box-shadow:0 2px 8px rgba(255,204,0,0.08);transform:translateY(0)}100%{box-shadow:0 0 0 rgba(255,204,0,0);transform:translateY(0)}}`;
  const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
})();

/* ---------------- SMALL UTIL: escape html ---------------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------------- TAB SWITCHING ---------------- */
document.getElementById('sidebar').addEventListener('click', (e) => {
  const btn = e.target.closest('.tab-button');
  if(!btn) return;
  const tab = btn.dataset.tab;
  if(!tab) return;
  document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none');
  const target = document.getElementById(tab);
  if(target) target.style.display='block';
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  // clear badges when opening Messages or Admin
  if(tab === 'messages' && currentUserUid) { clearUnread(currentUserUid).catch(()=>{}); const mbtn = document.querySelector('[data-tab="messages"]'); if(mbtn) mbtn.querySelector('.red-dot')?.remove(); }
  if(tab === 'admin' && currentUser && currentUser.email && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { const abtn = document.querySelector('[data-tab="admin"]'); if(abtn) abtn.querySelector('.red-dot')?.remove(); }
});

/* ---------------- AUTH UI ---------------- */
btnAuth.addEventListener('click', ()=> authModal.style.display='flex');
authClose.addEventListener('click', ()=> authModal.style.display='none');
authSignup.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pass = authPass.value.trim();
  if(!email||!pass) return alert('Enter email & password');
  try{ const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await set(ref(db, 'users/' + cred.user.uid), { email, createdAt: Date.now() });
    authModal.style.display='none'; alert('Account created & signed in');
  } catch(err){ alert(err.message || err); }
});
authLogin.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pass = authPass.value.trim();
  if(!email||!pass) return alert('Enter email & password');
  try{ await signInWithEmailAndPassword(auth, email, pass); authModal.style.display='none'; } catch(err){ alert(err.message || err); }
});
btnLogout.addEventListener('click', async ()=> { if(confirm('Logout?')) { try{ await signOut(auth); } catch(e){ console.error(e); } } });

/* ---------------- INJECT TABS (Messages & Admin) ---------------- */
function injectMessagesTab(){
  if(document.querySelector('[data-tab="messages"]')) return;
  const b = document.createElement('button'); b.className='tab-button'; b.dataset.tab='messages'; b.textContent='üí¨ Messages';
  b.addEventListener('click', ()=> { document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none'); document.getElementById('messages').style.display='block'; document.querySelectorAll('.tab-button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); loadUserChat(); });
  document.getElementById('sidebar').appendChild(b);
}
function injectAdminTab(){
  if(document.querySelector('[data-tab="admin"]')) return;
  const b = document.createElement('button'); b.className='tab-button'; b.dataset.tab='admin'; b.textContent='üõ† Admin';
  b.addEventListener('click', ()=> { document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none'); document.getElementById('admin').style.display='block'; document.querySelectorAll('.tab-button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); loadAdminUsers(); });
  document.getElementById('sidebar').appendChild(b);
}

/* ---------------- FLIPBOARDS & CITY LISTS ---------------- */
const FLIPS = [
  { city:'Chennai', title:'Engineering', link:'#' },
  { city:'Chennai', title:'Medical', link:'#' },
  { city:'Chennai', title:'Arts & Science', link:'#' },
  { city:'Pondicherry', title:'Engineering', link:'#' },
  { city:'Pondicherry', title:'Medical', link:'#' },
  { city:'Pondicherry', title:'Arts & Science', link:'#' },
  { city:'Coimbatore', title:'Engineering', link:'#' },
  { city:'Coimbatore', title:'Medical', link:'#' },
  { city:'Coimbatore', title:'Arts & Science', link:'#' },
  { city:'Trichy', title:'Engineering', link:'#' },
  { city:'Trichy', title:'Medical', link:'#' },
  { city:'Trichy', title:'Arts & Science', link:'#' },
  { city:'Madurai', title:'Engineering', link:'#' },
  { city:'Salem', title:'Engineering', link:'#' }
];

function renderFlipboards(){
  const grid = document.getElementById('flip-grid'); grid.innerHTML='';
  FLIPS.forEach(item => {
    const d = document.createElement('div'); d.className='flip';
    d.innerHTML = `<div style="font-weight:700">${item.city}</div><div style="margin-top:6px">${item.title}</div>`;
    const btn = document.createElement('button'); btn.className='view-btn'; btn.textContent='View';
    btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); // require login to open link
      if(!currentUserUid){ authModal.style.display='flex'; return; }
      // open link (placeholder)
      window.open(item.link, '_blank');
    });
    d.appendChild(btn);
    d.addEventListener('click', ()=> {
      const map = { Chennai:'chennai', Pondicherry:'pondy', Coimbatore:'coimbatore', Trichy:'trichy', Madurai:'madurai', Salem:'salem' };
      const id = map[item.city] || 'home';
      document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none');
      const el = document.getElementById(id); if(el) el.style.display='block';
    });
    grid.appendChild(d);
  });
}
renderFlipboards();

const SAMPLE = {
  "Chennai": { "Engineering":["IIT Madras","SSN College of Engineering","Anna University - CEG"], "Medical":["Madras Medical College","Stanley Medical College"], "Arts & Science":["Loyola College","Madras Christian College"] },
  "Coimbatore": { "Engineering":["PSG College of Technology","Coimbatore Institute of Technology"], "Medical":["Coimbatore Medical College"], "Arts & Science":["PSG College of Arts & Science"] },
  "Pondicherry": { "Engineering":["(sample)"], "Medical":["JIPMER"], "Arts & Science":["Pondy Arts College"] },
  "Trichy": { "Engineering":["NIT Trichy","Saranathan College"], "Medical":["KAPV Medical College"], "Arts & Science":["Bishop Heber College"] },
  "Madurai": { "Engineering":["Thiagarajar College of Engineering"], "Medical":["Madurai Medical College"], "Arts & Science":["The American College"] },
  "Salem": { "Engineering":["Sona College of Technology"], "Medical":["Vinayaka Missions Medical College"], "Arts & Science":["Sona Arts and Science College"] }
};

function renderCityLists(){
  ['chennai','coimbatore','pondy','trichy','madurai','salem'].forEach(id=>{
    const key = id === 'pondy' ? 'Pondicherry' : id.charAt(0).toUpperCase() + id.slice(1);
    const cont = document.getElementById(id + '-content'); cont.innerHTML = '';
    const obj = SAMPLE[key] || {};
    Object.keys(obj).forEach(cat=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<strong>${cat}</strong><div class="small">${obj[cat].length} colleges</div>`;
      obj[cat].forEach(c=>{
        const r = document.createElement('div'); r.style.padding='8px'; r.style.borderBottom='1px solid #f0f0f0';
        r.innerHTML = `<div style="font-weight:700">${c}</div><div class="small">‚Äî sample info</div>`;
        const v = document.createElement('button'); v.className='view-btn'; v.textContent='View';
        v.onclick = (ev)=> { ev.stopPropagation(); if(!currentUserUid){ authModal.style.display='flex'; return; } alert('Open details for ' + c); };
        r.appendChild(v);
        card.appendChild(r);
      });
      cont.appendChild(card);
    });
  });
}
renderCityLists();

/* ---------------- USER CHAT ---------------- */
async function loadUserChat(){
  if(!currentUserUid) return;
  userChatList.innerHTML = '<div style="font-weight:700">Your Chat</div><div class="small" style="margin-top:6px">Messages with admin</div>';
  chatMessages.innerHTML = '';
  const userRef = ref(db, 'chats/' + currentUserUid);
  off(userRef);
  onChildAdded(userRef, (snap)=>{
    const m = snap.val();
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === 'admin' ? 'admin' : 'user');
    el.innerHTML = `<div>${escapeHtml(m.text)}</div><div style="color:#666;font-size:11px;margin-top:6px">${new Date(m.time).toLocaleString()}</div>`;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // If admin replied to this user, show notification & badge for user
    if(m.from === 'admin' && currentUserUid){
      transientToast('New reply from admin');
      playBeep();
      const mbtn = document.querySelector('[data-tab="messages"]'); if(mbtn) { if(!mbtn.querySelector('.red-dot')) { const d = document.createElement('span'); d.className='red-dot'; mbtn.appendChild(d); } }
    }
  });

  chatSend.onclick = async function(){
    const txt = chatInput.value.trim(); if(!txt) return;
    await push(ref(db, 'chats/' + currentUserUid), { from:'user', text: txt, time: Date.now() });
    // increment admin unread
    await incrementUnreadFor('admin', 'user', currentUser ? currentUser.email : 'user');
    chatInput.value = '';
  };

  // clear unread for this user when viewing
  await clearUnread(currentUserUid);
  const mbtn = document.querySelector('[data-tab="messages"]');
  if(mbtn) mbtn.querySelector('.red-dot')?.remove();
}

/* ---------------- ADMIN UI ---------------- */
function buildUserRow(uid, userData, meta){
  const row = document.createElement('div');
  row.id = 'user-' + uid; row.style.padding='8px'; row.style.borderBottom='1px solid #eee'; row.style.cursor='pointer'; row.dataset.uid = uid;
  const emailText = escapeHtml(userData.email || uid);
  const unread = meta && meta.unread ? meta.unread : 0;
  const lastTime = meta && meta.lastTime ? meta.lastTime : 0;
  row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><div style="font-weight:700">${emailText}</div><div class="small">uid: ${uid}</div></div>
    <div style="text-align:right">${ unread>0 ? `<div style="font-weight:700;color:#e53935">${unread}</div>` : '' }<div class="small" style="color:#666;margin-top:6px">${ lastTime ? new Date(lastTime).toLocaleString() : '' }</div></div>
  </div>`;
  if(unread>0) row.classList.add('row-highlight');
  row.onclick = async ()=>{
    openAdminChat(uid, userData.email);
    await clearUnread(uid);
    row.classList.remove('row-highlight');
    await loadAdminUsers();
  };
  return row;
}

function moveUserToTop(uid){
  const userDiv = document.getElementById('user-'+uid);
  if(userDiv && adminUserList) adminUserList.insertBefore(userDiv, adminUserList.children[1] || null);
}

async function loadAdminUsers(){
  adminUserList.innerHTML = '<div style="font-weight:700">Users</div>';
  const usersRef = ref(db, 'users');
  off(usersRef);
  onValue(usersRef, async (snap)=>{
    const usersObj = snap.val() || {};
    const items = [];
    await Promise.all(Object.keys(usersObj).map(async uid=>{
      const u = usersObj[uid];
      const metaSnap = await get(ref(db, metaPath(uid)));
      const meta = metaSnap.exists() ? metaSnap.val() : {};
      items.push({ uid, user: u, meta });
    }));
    items.sort((a,b)=>{
      const au = a.meta && a.meta.unread ? a.meta.unread : 0;
      const bu = b.meta && b.meta.unread ? b.meta.unread : 0;
      if(au !== bu) return bu - au;
      const at = a.meta && a.meta.lastTime ? a.meta.lastTime : 0;
      const bt = b.meta && b.meta.lastTime ? b.meta.lastTime : 0;
      return bt - at;
    });
    adminUserList.innerHTML = '<div style="font-weight:700">Users</div>';
    items.forEach(it=>{
      const row = buildUserRow(it.uid, it.user, it.meta); adminUserList.appendChild(row);
    });
    const totalUnread = items.reduce((s,it)=> s + (it.meta && it.meta.unread ? it.meta.unread : 0), 0);
    const abtn = document.querySelector('[data-tab="admin"]'); if(abtn){ abtn.querySelector('.red-dot')?.remove(); if(totalUnread>0){ const d=document.createElement('span'); d.className='red-dot'; abtn.appendChild(d);} }
  });
}

function openAdminChat(uid, email){
  currentAdminChatUid = uid;
  adminChatHeader.innerHTML = `<strong>${escapeHtml(email||uid)}</strong>`;
  adminChatMessages.innerHTML = '';
  const chatRef = ref(db, 'chats/' + uid);
  off(chatRef);
  onChildAdded(chatRef, (snap)=>{
    const m = snap.val();
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === 'admin' ? 'admin' : 'user');
    el.innerHTML = `<div>${escapeHtml(m.text)}</div><div style="color:#666;font-size:11px;margin-top:6px">${new Date(m.time).toLocaleString()}</div>`;
    adminChatMessages.appendChild(el);
    adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
  });

  adminChatSend.onclick = async function(){
    const t = adminChatInput.value.trim(); if(!t || !currentAdminChatUid) return;
    await push(ref(db, 'chats/' + currentAdminChatUid), { from:'admin', text: t, time: Date.now() });
    await incrementUnreadFor(currentAdminChatUid, 'admin', currentUser ? currentUser.email : 'admin');
    await update(ref(db, metaPath(currentAdminChatUid)), { lastTime: Date.now(), lastSender: 'admin', lastSenderName: currentUser ? currentUser.email : 'admin' });
    adminChatInput.value = '';
    moveUserToTop(currentAdminChatUid);
  };

  clearUnread(uid).catch(()=>{});
}

/* ---------------- META (unread) helpers ---------------- */
async function incrementUnreadFor(uid, from, senderName){
  try {
    const mref = ref(db, metaPath(uid));
    const snap = await get(mref);
    const cur = snap.exists() ? (snap.val()||{}) : {};
    const newCount = (cur.unread||0) + 1;
    const payload = { unread: newCount, lastTime: Date.now(), lastSender: from, lastSenderName: senderName || cur.lastSenderName || '' };
    await set(mref, Object.assign({}, cur, payload));
  } catch(e){ console.error('incUnread', e); }
}
async function clearUnread(uid){
  try {
    const mref = ref(db, metaPath(uid));
    const snap = await get(mref);
    const cur = snap.exists() ? (snap.val()||{}) : {};
    if(cur.unread && cur.unread>0){ cur.unread = 0; await set(mref, cur); }
  } catch(e){ console.error('clear unread', e); }
}

/* ---------------- GLOBAL CHAT WATCHER (set meta + notify admin/user) ---------------- */
onChildAdded(ref(db, 'chats'), (snapUserChats) => {
  const uid = snapUserChats.key;
  const userChatRef = ref(db, 'chats/' + uid);
  onChildAdded(userChatRef, async (msgSnap) => {
    const m = msgSnap.val();
    if(!m) return;
    const from = m.from || 'user';
    const time = m.time || Date.now();
    if(from === 'user'){
      await incrementUnreadFor('admin', 'user', null);
      await update(ref(db, metaPath(uid)), { lastTime: time, lastSender: 'user' });
      // if admin is online, show transient
      if(currentUser && currentUser.email && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()){
        transientToast(`New message from ${uid}`);
        playBeep();
        const row = document.getElementById('user-'+uid); if(row){ row.classList.add('row-highlight'); row.classList.add('notify-flash'); setTimeout(()=>row.classList.remove('notify-flash'),1600); }
        const abtn = document.querySelector('[data-tab="admin"]'); if(abtn && !abtn.querySelector('.red-dot')){ const d=document.createElement('span'); d.className='red-dot'; abtn.appendChild(d); }
      }
      moveUserToTop(uid);
    } else if(from === 'admin'){
      await incrementUnreadFor(uid, 'admin', currentUser ? currentUser.email : 'admin');
      // user's loadUserChat onChildAdded will show toast & badge
    }
  });
});

/* ---------------- AUTH STATE ---------------- */
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    welcomeTxt.textContent = user.email;
    sidebarUser.textContent = user.email;
    currentUserUid = user.uid;
    injectMessagesTab();
    if(user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()){
      injectAdminTab();
      document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none');
      document.getElementById('admin').style.display='block';
    } else {
      document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none');
      document.getElementById('messages').style.display='block';
    }
    set(ref(db, 'users/' + user.uid), { email: user.email, createdAt: Date.now() }).catch(()=>{});
    await loadUserChat();
    try {
      const metaSnap = await get(ref(db, metaPath(user.uid)));
      const meta = metaSnap.exists() ? metaSnap.val() : {};
      const mbtn = document.querySelector('[data-tab="messages"]');
      if(meta && meta.unread && meta.unread > 0){ if(mbtn && !mbtn.querySelector('.red-dot')){ const d=document.createElement('span'); d.className='red-dot'; mbtn.appendChild(d);} } else { if(mbtn) mbtn.querySelector('.red-dot')?.remove(); }
    } catch(e){ console.error(e); }
  } else {
    welcomeTxt.textContent = 'Not signed in';
    sidebarUser.textContent = '‚Äî';
    currentUserUid = null;
    const mbtn = document.querySelector('[data-tab="messages"]'); if(mbtn) mbtn.remove();
    const abtn = document.querySelector('[data-tab="admin"]'); if(abtn) abtn.remove();
    document.querySelectorAll('[data-section]').forEach(s=>s.style.display='none');
    document.getElementById('home').style.display='block';
  }
});

/* ---------------- FIN ---------------- */
console.log('Single-file index.html loaded (Firebase + chat integrated).');

</script>
</body>
</html>
