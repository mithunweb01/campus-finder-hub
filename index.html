<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Campus Finder Hub</title>
<link rel="icon" href="my-logo.png" />

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>

<style>
    body { margin:0; font-family:Arial; background:#f4f4f4; }
    .tabs { display:flex; overflow-x:auto; background:#0055ff; padding:10px; }
    .tabs button { margin-right:10px; background:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .tabs button.active { background:#ffd500; }
    .page { display:none; padding:20px; }

    /* LOGIN SCREEN */
    #loginScreen { padding:30px; max-width:300px; margin:auto; margin-top:60px; display:none; }
    #loginScreen input { width:100%; padding:10px; margin-bottom:12px; border-radius:6px; border:1px solid #ccc; }
    #loginScreen button { width:100%; padding:10px; background:#0055ff; border:none; color:white; border-radius:8px; font-weight:bold; }

    /* PROFILE */
    .avatar { width:90px; height:90px; border-radius:50%; background:#ddd; display:flex; justify-content:center; align-items:center; font-size:40px; font-weight:bold; overflow:hidden; }
    #avatarImg { width:100%; height:100%; object-fit:cover; display:none; }

    /* MESSAGE AREA */
    #messagesBox { background:white; padding:10px; height:300px; overflow-y:auto; border-radius:10px; }
    .msg { padding:8px; margin-bottom:8px; background:#eef; border-radius:6px; }
    .msg.admin { background:#ffe4a8; font-weight:bold; }

    /* ADMIN USER LIST */
    .userCard { display:flex; align-items:center; background:white; padding:8px; border-radius:10px; margin-bottom:8px; cursor:pointer; }
    .userCard span { margin-left:10px; font-weight:bold; }
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginScreen">
    <h2>Login</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
</div>

<!-- NAVIGATION -->
<div id="nav" class="tabs" style="display:none;">
    <button onclick="openTab('home')" class="tabBtn">Home</button>
    <button onclick="openTab('chennai')" class="tabBtn">Chennai</button>
    <button onclick="openTab('pondy')" class="tabBtn">Pondicherry</button>
    <button onclick="openTab('coimbatore')" class="tabBtn">Coimbatore</button>
    <button onclick="openTab('trichy')" class="tabBtn">Trichy</button>
    <button onclick="openTab('madurai')" class="tabBtn">Madurai</button>
    <button onclick="openTab('message')" class="tabBtn">Message</button>
    <button onclick="openTab('profile')" class="tabBtn">Profile</button>
    <button onclick="openTab('admin')" class="tabBtn" id="adminBtn" style="display:none;">Admin</button>
</div>

<!-- HOME -->
<div id="home" class="page">
    <h2>Welcome to Campus Finder Hub</h2>
    <p>Your existing content stays unchanged.</p>
</div>

<!-- OTHER TABS (unchanged layout) -->
<div id="chennai" class="page"><h2>Chennai Colleges</h2></div>
<div id="pondy" class="page"><h2>Pondicherry Colleges</h2></div>
<div id="coimbatore" class="page"><h2>Coimbatore Colleges</h2></div>
<div id="trichy" class="page"><h2>Trichy Colleges</h2></div>
<div id="madurai" class="page"><h2>Madurai Colleges</h2></div>

<!-- MESSAGE TAB -->
<div id="message" class="page">
    <h2>Messages</h2>
    <div id="messagesBox"></div>

    <input id="msgInput" placeholder="Type message..." style="padding:8px;width:70%;">
    <button onclick="sendMessage()">Send</button>
</div>

<!-- PROFILE TAB -->
<div id="profile" class="page">
    <h2>Your Profile</h2>
    <div class="avatar" id="profileAvatar">
        <span id="avatarLetter"></span>
        <img id="avatarImg">
    </div>

    <p><b>Name:</b> <span id="profileName"></span></p>
    <p><b>Email:</b> <span id="profileEmail"></span></p>
    <p><b>Messages Sent:</b> <span id="msgCount"></span></p>
    <p><b>Replies Received:</b> <span id="replyCount"></span></p>

    <input type="file" id="picUpload" onchange="uploadProfilePic()">
</div>

<!-- ADMIN TAB -->
<div id="admin" class="page">
    <h2>Admin Panel (Mithun)</h2>
    <div id="userList"></div>
</div>

<script>
// ---------------- FIREBASE ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDjW_3cYR8apPFMmZqLqZh_9i2bN-1IEmY",
  authDomain: "college-finder-279aa.firebaseapp.com",
  databaseURL: "https://college-finder-279aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "college-finder-279aa",
  storageBucket: "college-finder-279aa.firebasestorage.app",
  messagingSenderId: "94401695690",
  appId: "1:94401695690:web:380de91d4f168ea2944933",
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ---------------- LOGIN ----------------
function login() {
    let email = email.value;
    let pass = password.value;

    auth.signInWithEmailAndPassword(email, pass)
    .then(() => {
        loginScreen.style.display = "none";
        nav.style.display = "flex";
        loadProfile();
        loadMessages();
        loadUsers();
        if (email === "mithun@admin.com") adminBtn.style.display = "block";
        openTab('home');
    })
    .catch(err => alert(err.message));
}

// ---------------- TAB SYSTEM ----------------
function openTab(id) {
    document.querySelectorAll('.page').forEach(p => p.style.display = "none");
    document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove("active"));
    document.getElementById(id).style.display = "block";

    let btn = [...document.querySelectorAll('.tabBtn')]
              .find(x => x.textContent.toLowerCase() === id.toLowerCase());
    if (btn) btn.classList.add("active");
}

// ---------------- PROFILE ----------------
function loadProfile() {
    let user = auth.currentUser;
    profileEmail.textContent = user.email;

    db.ref("users/" + user.uid).once("value").then(s => {
        let data = s.val() || {};

        let name = data.name || user.email.split("@")[0];
        profileName.textContent = name;

        msgCount.textContent = data.msgCount || 0;
        replyCount.textContent = data.replyCount || 0;

        if (data.photoURL) {
            avatarImg.src = data.photoURL;
            avatarImg.style.display = "block";
            avatarLetter.style.display = "none";
        } else {
            avatarLetter.textContent = name.charAt(0).toUpperCase();
        }
    });
}

// ---------------- PROFILE PIC UPLOAD ----------------
function uploadProfilePic() {
    let file = picUpload.files[0];
    let uid = auth.currentUser.uid;
    let ref = storage.ref("profiles/" + uid + ".jpg");

    ref.put(file).then(() => {
        ref.getDownloadURL().then(url => {
            db.ref("users/" + uid).update({ photoURL: url });
            avatarImg.src = url;
            avatarImg.style.display = "block";
            avatarLetter.style.display = "none";
        });
    });
}

// ---------------- MESSAGES ----------------
function loadMessages() {
    db.ref("messages").on("value", snap => {
        messagesBox.innerHTML = "";
        snap.forEach(msg => {
            let m = msg.val();
            let div = document.createElement("div");
            div.className = "msg" + (m.sender === "admin" ? " admin" : "");
            div.textContent = (m.sender === "admin" ? "Admin: " : "User: ") + m.text;
            messagesBox.appendChild(div);
        });
        messagesBox.scrollTop = messagesBox.scrollHeight;
    });
}

function sendMessage() {
    let user = auth.currentUser;
    let isAdmin = user.email === "mithun@admin.com";
    let text = msgInput.value;

    db.ref("messages").push({
        sender: isAdmin ? "admin" : "user",
        text,
        uid: user.uid,
        time: Date.now()
    });

    db.ref("users/" + user.uid).transaction(d => {
        if (!d) d = {};
        if (isAdmin) d.replyCount = (d.replyCount || 0) + 1;
        else d.msgCount = (d.msgCount || 0) + 1;
        return d;
    });

    msgInput.value = "";
}

// ---------------- ADMIN TAB ----------------
function loadUsers() {
    if (!auth.currentUser) return;
    if (auth.currentUser.email !== "mithun@admin.com") return;

    db.ref("users").on("value", snap => {
        userList.innerHTML = "";
        snap.forEach(u => {
            let d = u.val();
            let card = document.createElement("div");
            card.className = "userCard";
            card.innerHTML = `
                <div class="avatar" style="width:40px;height:40px;font-size:20px;">
                    ${d.photoURL ? `<img src="${d.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                                  : d.name ? d.name.charAt(0).toUpperCase() : "U"}
                </div>
                <span>${d.name || d.email}</span>
            `;
            userList.appendChild(card);
        });
    });
}
</script>

</body>
</html>
