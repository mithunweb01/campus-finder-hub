<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campus Finder Hub ‚Äî Messages</title>

<!-- Favicon (your M shield ‚Äî embedded) -->
<link rel="icon" type="image/png"
href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA...YOUR_FULL_LOGO_BASE64...etc">

<style>
/* BASIC UI RESET */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #fafafa;
}

/* TABS */
.tab-bar {
  display: flex;
  background: #8B0000;
  color: #fff;
}
.tab {
  flex: 1;
  text-align: center;
  padding: 14px;
  cursor: pointer;
  font-weight: bold;
}
.tab.active {
  background: #600000;
}

.section { display: none; padding: 20px; }
.section.active { display: block; }

/* FLIPBOARD */
.flipboard {
  background: #222;
  color: #0f0;
  padding: 20px;
  font-size: 20px;
  border-radius: 10px;
  margin-bottom: 15px;
}

/* MESSAGES */
.msg-box {
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  margin: 10px 0;
  display: flex;
  gap: 10px;
  align-items: flex-start;
  border-left: 5px solid #8B0000;
}
.msg-admin { border-left-color: gold; }

.dp {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #ccc;
  object-fit: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
}

/* PROFILE */
.profile-card {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  margin-top: 10px;
}

/* LOGIN BOX */
#loginBox {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex; justify-content: center; align-items: center;
}
.login-inner {
  background: #fff; padding: 20px; width: 300px;
  border-radius: 10px; text-align: center;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js"></script>

<script>
// ---------------- FIREBASE CONFIG (your same config) ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDjW_3cYR8apPFMmZqLqZh_9i2bN-1IEmY",
  authDomain: "college-finder-279aa.firebaseapp.com",
  databaseURL: "https://college-finder-279aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "college-finder-279aa",
  storageBucket: "college-finder-279aa.appspot.com",
  messagingSenderId: "265575945526",
  appId: "1:265575945526:web:4cd2ef244dc411e21bbec3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const messaging = firebase.messaging();
</script>
</head>

<body>

<!-- ---------------- LOGIN POPUP ---------------- -->
<div id="loginBox">
  <div class="login-inner">
    <h2>Login</h2>
    <input id="emailInput" placeholder="Enter Email" style="width:100%;padding:10px"><br><br>
    <button onclick="loginNow()" style="padding:10px 20px;background:#8B0000;color:#fff;border:none;border-radius:5px;">Login</button>
  </div>
</div>

<!-- ---------------- TABS ---------------- -->
<div class="tab-bar">
  <div class="tab active" onclick="openTab('home')">Home</div>
  <div class="tab" onclick="openTab('cities')">Cities</div>
  <div class="tab" onclick="openTab('messages')">Messages</div>
  <div class="tab" onclick="openTab('profile')">Profile</div>
</div>

<!-- ---------------- HOME ---------------- -->
<div id="home" class="section active">
  <div class="flipboard">üéì Welcome to Campus Finder Hub</div>
  <div class="flipboard">‚úî Real-time Updates</div>
  <div class="flipboard">‚úî Message Support (Evening Replies)</div>
</div>

<!-- ---------------- CITIES ---------------- -->
<div id="cities" class="section">
  <h2>Cities</h2>

  <div class="flipboard">üìç Chennai ‚Äî Top Engineering / Arts Colleges</div>
  <div class="flipboard">üìç Coimbatore ‚Äî Best Placements</div>
  <div class="flipboard">üìç Madurai ‚Äî Affordable Colleges</div>
  <div class="flipboard">üìç Trichy ‚Äî Reputed Universities</div>
  <div class="flipboard">üìç Salem ‚Äî Eco-friendly Campuses</div>
</div>

<!-- ---------------- MESSAGES ---------------- -->
<div id="messages" class="section">
  <h2>Messages</h2>

  <div id="msgList"></div>

  <input id="msgInput" placeholder="Type message‚Ä¶" style="width:70%;padding:10px">
  <button onclick="sendMessage()" style="padding:10px 20px;background:#8B0000;color:white;border:none;border-radius:5px;">
    Send
  </button>
</div>

<!-- ---------------- PROFILE ---------------- -->
<div id="profile" class="section">
  <h2>Your Profile</h2>

  <div class="profile-card">
    <div id="dp" class="dp" style="margin:auto;"></div>

    <br>

    <input type="file" id="dpUpload" accept="image/*" onchange="uploadDP()">

    <p><b>Email:</b> <span id="pEmail"></span></p>
    <p><b>Username:</b> <span id="pUser"></span></p>
    <p><b>Joined:</b> <span id="pJoin"></span></p>
    <p><b>Messages Sent:</b> <span id="pCount"></span></p>
  </div>
</div>

<script>
// ---------------- TAB SYSTEM ----------------
function openTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));

  event.target.classList.add("active");
  document.getElementById(name).classList.add("active");
}

// ---------------- LOGIN SYSTEM (EMAIL ONLY) ----------------
let currentUID = null;
const ADMIN_EMAIL = "admin@mithun.com";

// Shows username popup for new users
async function askUsername(uid,email){
  let username = prompt("Enter username");
  if(!username) username = "User";

  await db.ref("users/"+uid).set({
    email: email,
    username: username,
    joined: new Date().toDateString(),
    messages: 0,
    profileUrl: "",
  });
}

async function loginNow(){
  let email = document.getElementById("emailInput").value.trim();

  // Email-only login ‚Üí use signInAnonymously + store mapping
  const res = await auth.signInAnonymously();
  const uid = res.user.uid;

  currentUID = uid;

  // Save user data
  const snap = await db.ref("users/"+uid).once("value");

  if(!snap.exists()){
    // New user
    await askUsername(uid,email);
  }

  // Remove login popup
  document.getElementById("loginBox").style.display="none";

  loadProfile();
  loadMessages();
  getTokenAndSave();
}

// ---------------- PROFILE LOAD ----------------
async function loadProfile(){
  let snap = await db.ref("users/"+currentUID).once("value");
  let u = snap.val();

  document.getElementById("pEmail").innerText = u.email;
  document.getElementById("pUser").innerText = u.username;
  document.getElementById("pJoin").innerText = u.joined;
  document.getElementById("pCount").innerText = u.messages || 0;

  if(u.profileUrl){
    document.getElementById("dp").style.backgroundImage = `url(${u.profileUrl})`;
    document.getElementById("dp").style.backgroundSize = "cover";
  } else {
    document.getElementById("dp").innerText = u.username[0].toUpperCase();
  }
}

// ---------------- DP UPLOAD ----------------
function uploadDP(){
  const file = document.getElementById("dpUpload").files[0];
  const reader = new FileReader();

  reader.onload = function(){
    db.ref("users/"+currentUID+"/profileUrl").set(reader.result);
    document.getElementById("dp").style.backgroundImage = `url(${reader.result})`;
    document.getElementById("dp").innerHTML = "";
  };
  reader.readAsDataURL(file);
}

// ---------------- SEND MESSAGE ----------------
async function sendMessage(){
  let text = document.getElementById("msgInput").value;
  if(!text) return;

  const userSnap = await db.ref("users/"+currentUID).once("value");
  const user = userSnap.val();

  const isAdmin = user.email === ADMIN_EMAIL;

  await db.ref("messages").push({
    uid: currentUID,
    username: user.username,
    email: user.email,
    text: text,
    time: new Date().toLocaleTimeString(),
    admin: isAdmin,
  });

  db.ref("users/"+currentUID+"/messages").transaction(v => (v||0)+1);

  document.getElementById("msgInput").value="";
}

// ---------------- LOAD MESSAGES ----------------
db.ref("messages").on("child_added", snap=>{
  let m = snap.val();

  let div = document.createElement("div");
  div.className = "msg-box " + (m.admin ? "msg-admin" : "");

  let badge = m.admin ? "‚≠ê ADMIN" : "üë§ USER";
  let dp = `<div class="dp">${m.username[0].toUpperCase()}</div>`;

  div.innerHTML = `
    ${dp}
    <div>
      <b>${m.username}</b> <small>${badge}</small><br>
      ${m.text}<br>
      <small>${m.time}</small>
    </div>
  `;
  document.getElementById("msgList").appendChild(div);
});

// ---------------- REAL PUSH NOTIFICATIONS ----------------
async function getTokenAndSave(){
  try {
    const token = await messaging.getToken({
      vapidKey: "YOUR_VAPID_KEY_HERE"
    });

    if(token){
      db.ref("users/"+currentUID+"/token").set(token);
    }
  } catch(e){
    console.log("Permission denied",e);
  }
}

// Register service worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("firebase-messaging-sw.js");
}
</script>

</body>
</html>
